<!DOCTYPE html>
<html>
<head>
<base target="_top">
<style>
  body {
    background-color: #050505;
    margin: 0;
    overflow: hidden;
    font-family: 'Roboto', sans-serif;
  }

  #stage {
    display: flex;
    width: 100vw;
    height: 100vh;
    padding: 0 10px;
    gap: 15px;
    box-sizing: border-box;
  }

  .column {
    flex: 1;
    position: relative;
    will-change: transform; 
  }

  .photo-card {
    position: relative;
    width: 100%;
    margin-bottom: 15px; 
    border-radius: 8px;
    overflow: hidden;
    background: #151515; 
    transform: translateZ(0);
    transition: box-shadow 0.5s ease;
  }

  /* Limit height so one massive image doesn't block the flow */
  .photo-card img {
    width: 100%;
    max-height: 60vh; 
    object-fit: cover; 
    display: block;
    opacity: 0;
    transition: opacity 0.5s ease;
  }

  .photo-card img.loaded { opacity: 1; }

  /* HIGHLIGHT NEW PHOTOS */
  .photo-card.new-arrival {
    box-shadow: 0 0 0 4px #fff, 0 0 20px #fff;
    z-index: 10;
  }

  /* Status Dashboard */
  #dashboard {
    position: fixed;
    bottom: 20px; right: 20px;
    background: rgba(0,0,0,0.8);
    color: #888;
    padding: 8px 12px;
    border-radius: 20px;
    font-size: 11px;
    font-family: monospace;
    display: flex; align-items: center; gap: 8px;
    border: 1px solid #333;
    z-index: 100;
  }
  #dot { width: 8px; height: 8px; background: #555; border-radius: 50%; }
  #dot.ping { background: #0f0; box-shadow: 0 0 5px #0f0; }
</style>
</head>
<body>

<div id="dashboard">
  <div id="dot"></div>
  <span id="msg">Initializing...</span>
</div>

<div id="stage">
  <div class="column"></div>
  <div class="column"></div>
  <div class="column"></div>
  <div class="column"></div>
</div>

<script>
  // --- TUNING ---
  const SCROLL_SPEED = 1.5; 
  const POLL_INTERVAL = 5000;
  const BUFFER = 20; // Lower = Faster appearance of new photos

  // --- STATE ---
  let knownIds = new Set();
  let masterPool = []; // Old photos
  let priorityQueue = []; // New photos
  let poolIndex = 0;
  let isFirstLoad = true;

  const columns = Array.from(document.querySelectorAll('.column')).map(el => ({
    el: el,
    y: 0
  }));

  // --- CORE LOOP ---
  function init() {
    fetchData();
    setInterval(fetchData, POLL_INTERVAL);
    requestAnimationFrame(tick);
  }

  // --- DATA SYNC ---
  function fetchData() {
    const dot = document.getElementById('dot');
    dot.classList.add('ping');
    setTimeout(() => dot.classList.remove('ping'), 500);

    google.script.run
      .withSuccessHandler(processImages)
      .withFailureHandler(e => document.getElementById('msg').innerText = "Error")
      .getRecentImages(Date.now());
  }

  function processImages(images) {
    let newCount = 0;
    const msg = document.getElementById('msg');

    // Process Oldest -> Newest
    for (let i = images.length - 1; i >= 0; i--) {
      const img = images[i];
      if (!knownIds.has(img.id)) {
        knownIds.add(img.id);
        
        // If it's the very first load, populate the pool quietly
        if (isFirstLoad) {
          masterPool.push(img);
        } else {
          // LIVE EVENT: Add to priority queue
          priorityQueue.push(img);
          masterPool.push(img); // Also add to pool for later recycling
          newCount++;
        }
      }
    }

    if (isFirstLoad && masterPool.length > 0) {
      isFirstLoad = false;
      msg.innerText = "Live";
    }

    if (newCount > 0) {
      msg.innerText = `New: ${newCount} photo(s)`;
      msg.style.color = "#fff";
      setTimeout(() => { msg.innerText = "Live"; msg.style.color = "#888"; }, 4000);
    }
  }

  // --- ANIMATION ---
  function tick() {
    const stageH = window.innerHeight;

    columns.forEach(col => {
      // 1. Move
      col.y -= SCROLL_SPEED;
      col.el.style.transform = `translate3d(0, ${col.y}px, 0)`;

      // 2. Remove Top (Garbage Collection)
      if (col.y < -300) { // Optimization check
        const first = col.el.firstElementChild;
        if (first) {
          const h = first.offsetHeight + 15;
          if (col.y < -h) {
            first.remove();
            col.y += h; // Snap back
            col.el.style.transform = `translate3d(0, ${col.y}px, 0)`;
          }
        }
      }

      // 3. Add Bottom (Just-in-Time)
      const colHeight = col.el.offsetHeight;
      const visualBottom = colHeight + col.y;
      
      // Only add if the bottom is essentially ON SCREEN
      // This keeps the "waiting line" empty so new photos fit immediately
      if (visualBottom < stageH + BUFFER) {
        appendImage(col);
      }
    });

    requestAnimationFrame(tick);
  }

  function appendImage(colObj) {
    if (masterPool.length === 0) return;

    let data;
    let isNew = false;

    // PRIORITY CHECK
    if (priorityQueue.length > 0) {
      data = priorityQueue.shift();
      isNew = true;
      console.log("Injecting NEW photo:", data.id);
    } else {
      // Recycle Old
      data = masterPool[poolIndex % masterPool.length];
      poolIndex++;
    }

    const card = document.createElement('div');
    card.className = 'photo-card';
    if (isNew) card.className += ' new-arrival';

    const img = new Image();
    img.src = data.url;
    img.loading = "eager"; // Force load
    
    img.onload = () => {
      img.classList.add('loaded');
      // If new, remove the glow after 5 seconds
      if (isNew) {
        setTimeout(() => card.classList.remove('new-arrival'), 5000);
      }
    };

    card.appendChild(img);
    colObj.el.appendChild(card);
  }

  init();
</script>
</body>
</html>
